!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Mark=t()}(this,function(){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function e(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function i(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function p(e,t){return new RegExp("^".concat(t,"$"),"i").test(e.nodeName)}function g(e){return/^(\s*)\n+(\s*)$/.test(e)}function h(e){return"string"==typeof e&&(e=e.replace(/\u200B/g,"")),e}function s(e,t){function n(e){return"---------- ".concat(t," ").concat(e?"start":"end"," ----------")}console.log(n(1)),console.log(e),console.log(n(0))}function v(e,t){var n,r;n=e,0!=(r=(r=t)||"").replace(/\s/g,"").length&&new RegExp(" "+r+" ").test(" "+n.className+" ")||(e.className=""==e.className?t:e.className+" "+t)}var t=function(){function n(e){o(this,n);var t=Object.assign({debug:!1},e);this.options=t}return e(n,[{key:"create",value:function(e,t){var n=t&&t.selection||window.getSelection();return this.tagName=e||"mark",this._create(n)}},{key:"_create",value:function(e){var t=[];if(0<e.rangeCount){var n=e.getRangeAt(0),r=n.startContainer,o=n.endContainer;if(r&&o)if(r===o||r.parentNode===o.parentNode){var a=this._createMarkElement();n.surroundContents(a),t.push(a)}else{var i=this._surroundCrossContents(n);t=t.concat(i)}else r?o||console.error("range.endContainer does not exist"):console.error("range.startContainer does not exist");e.removeAllRanges()}return t}},{key:"_getRangeBy",value:function(e){var t=e.commonAncestorContainer,l=e.startContainer,f=e.endContainer,d=[],p="",h="";return function e(t,n){for(var r,o,a,i=t.childNodes,s=0;s<i.length;s++){var c=n?"".concat(n,"-").concat(s):"".concat(s),u=i[s];if(""!==h)break;u===l&&(p=c),u===f&&(h=c),""===p||3===u.nodeType&&g(u.nodeValue)||d.push((a=u,(o=c)in(r={})?Object.defineProperty(r,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[o]=a,r)),1===u.nodeType&&(u.contains(l)||u.contains(f))&&e(u,c)}}(t),{nodeList:d,startkey:p,endkey:h,startOffset:e.startOffset,endOffset:e.endOffset}}},{key:"_surroundCrossContents",value:function(e){var l=this,t=this.options,n=this._getRangeBy(e),r=n.nodeList,f=n.startkey,d=n.endkey,p=n.startOffset,h=n.endOffset,g=[];return t.debug&&(s(this._createDOMTree(e),"tree"),s(n,"newRange")),r.forEach(function(e){var t,n,r,o,a=Object.keys(e)[0],i=e[a],s=i.parentNode,c=i.nodeValue,u=l._createMarkElement();0<l._compare(a,f)&&l._compare(a,d)<0?(3===i.nodeType?(u.innerText=c,s.replaceChild(u,i)):(u.innerHTML=i.innerHTML,i.innerHTML="",i.appendChild(u)),g.push(u)):3===i.nodeType&&(a===f?(t=i.nextSibling,u.innerText=c.substr(p),i.nodeValue=c.substr(0,p),t?s.insertBefore(u,t):s.appendChild(u),g.push(u)):a===d&&(t=i.previousSibling,u.innerText=c.substr(0,h),i.nodeValue=c.substr(h),t?(n=u,(o=(r=t).parentNode).lastChild==r?o.appendChild(n):o.insertBefore(n,r.nextSibling)):s.insertBefore(u,i),g.push(u)))}),g}},{key:"_compare",value:function(e,t){for(var n,r=e.split("-"),o=t.split("-"),a=r.length-o.length?r.length:o.length,i=0;i<a;i++){var s=parseInt(r[i],10)-parseInt(o[i],10);if(0!=s||i===a-1){n=s;break}}return n}},{key:"_createMarkElement",value:function(){var e=this.tagName;return document.createElement(e)}},{key:"_createDOMTree",value:function(e){var t=e.commonAncestorContainer,i=e.startContainer,s=e.endContainer,n={},c="",u="";return function r(e,o,a){e.childNodes.forEach(function(e,t){var n=a?"".concat(a,"-").concat(t):"".concat(t);e===i&&(c=n),e===s&&(u=n),o[n]={},3!==(o[n].node=e).nodeType&&(o[n].child={},r(e,o[n].child,n))})}(t,n),{constructor:n,startkey:c,endkey:u}}}]),n}();return function(){function r(e,t){var n;if(o(this,r),n=i(this,a(r).call(this,t)),null===e)throw new Error("TextareaElem does not exist");return n.options=Object.assign({tagName:"mark",debug:!1},n.options),n.textareaElem=e,n.innerData={points:[]},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}(r,t),e(r,[{key:"mark",value:function(e,t){if("exchange"===e){if(!(t&&t.points&&0<t.points.length))throw new Error("Required parameter options.points");this.innerData.points=t.points.sort(function(e,t){return e-t})}return this._mark(e)}},{key:"automark",value:function(c,u){var l=this;if(c&&0<c.length){var f=0;window.getSelection().removeAllRanges(),function e(){var t=c[f],n=l._getRangeData(t.startOffset,t.endOffset),r=window.getSelection(),o=window.document.createRange(),a=n.startRange,i=n.endRange;try{o.setStart(a.node,a.offset),o.setEnd(i.node,i.offset),r.addRange(o)}catch(e){console.error(e),console.error("".concat(JSON.stringify(t)))}var s=l._mark(t.type,t);u&&u.afterEach&&u.afterEach(s),++f<=c.length-1?e():u&&u.after&&u.after()}()}}},{key:"getContent",value:function(){var e=window.getSelection().getRangeAt(0),t="";return e&&(t=e.toString()),t.replace(/\n/g,"").trim()}},{key:"innerText",value:function(){var o="";return function e(t){for(var n=0;n<t.length;n++){var r=t[n];3!==r.nodeType||g(r.nodeValue)?1===r.nodeType&&(e(r.childNodes),p(r,"p")&&(o+="\n")):o+=r.nodeValue}}(this.textareaElem.childNodes),h(o)}},{key:"_mark",value:function(e,t){var n,r=window.getSelection();if(0<r.rangeCount){var o=r.getRangeAt(0),a=o.startContainer===o.endContainer&&o.startOffset===o.endOffset,i=this.create(this.options.tagName,r);0<i.length&&(t?n=t:((n=this._getData(i[0],i[i.length-1])).content=a?"缺漏":n.content,n.points="exchange"===e?this.innerData.points:[],n.key=function(){for(var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],t="",n=0;n<13;n++){t+=e[Math.round(Math.random()*(e.length-1))]}return t}(),n.type=a?"missing":e),this._setElems(i,n))}return n}},{key:"_setElems",value:function(e,t){if(e&&0<e.length){var n="exchange"===t.type?this._drawExchange(t):null;e.forEach(function(e){e.setAttribute("markkey",t.key),e.setAttribute("marktype",t.type),v(e,"mark-error mark-".concat(t.type)),n&&n(e)})}}},{key:"_drawExchange",value:function(l){var f=0,d=l&&l.points||this.innerData.points,p=l&&l.content.replace(/\n/g,"");return function e(t){for(var n=Array.prototype.slice.call(t.childNodes),r=0;r<n.length;r++){var o=n[r];if(3!==o.nodeType||g(o.nodeValue))1===o.nodeType&&e(o);else{for(var a=o.nodeValue,i=document.createDocumentFragment(),s=0;s<a.length;s++){var c="",u=document.createElement("i");u.innerHTML=a.charAt(s),0==f?c="left":f===p.length-1&&(c="right"),v(u,c),v(u,c=f==d[0]?"focus focus1":d[1]&&f===d[1]+1?"focus focus2":f<d[0]||d[1]&&f>d[1]+1?"top":"bottom"),u.setAttribute("marktype",l.type),i.appendChild(u),f++}o.parentNode.replaceChild(i,o)}}}}},{key:"_getData",value:function(i,s){var c=0,u="",l=null,f=null,d=null;return function e(t){for(var n=0;n<t.length;n++){var r=t[n];if(null!==f)break;if(3!==r.nodeType||g(r.nodeValue)){if(1===r.nodeType){if(r===i&&(l=c),r===s){var o=r.innerText;f=c+o.length,d=f-l,u+=o}e(r.childNodes),!f&&p(r,"p")&&(c++,u+="\n")}}else{var a=h(r.nodeValue);c+=a.length,u+=null!==l?a:""}}}(this.textareaElem.childNodes),{content:u.trim(),startOffset:l,endOffset:f,length:d}}},{key:"_getRangeData",value:function(c,u){var l=0,f=null,d=null;return function e(t){for(var n=0;n<t.length;n++){var r=t[n];if(null!==d)break;if(3!==r.nodeType||g(r.nodeValue))1===r.nodeType&&(e(r.childNodes),!d&&p(r,"p")&&l++);else{var o=l,a=h(r.nodeValue);if(l+=a.length,!f&&c<=l){var i=c-o;f={node:r,offset:i<0?0:i}}if(!d&&u<=l){var s=u-o;d={node:r,offset:s<0?0:s}}}}}(this.textareaElem.childNodes),{startRange:f,endRange:d}}}]),r}()});
